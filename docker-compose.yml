version: '3.8'

services:
  client:
    build:
      context: ./client
      dockerfile: Dockerfile
    container_name: madcamp_client
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      # Note: NEXT_PUBLIC_ variables are typically baked in at build time or handled via runtime config.
      # Client connects to server-gpu (port 8000) by default
      - NEXT_PUBLIC_USE_MOCK=false
      - NEXT_PUBLIC_STEM_API_URL=http://localhost:18000/api/stems
      - NEXT_PUBLIC_TRANSITION_API_URL=http://localhost:18000/api/transition
    depends_on:
      - server-gpu
    restart: always

  # Primary Server (GPU Enabled) - Port 8000
  server-gpu:
    build:
      context: ./server
      dockerfile: Dockerfile
    container_name: madcamp_server_gpu
    ports:
      - "18000:3001" # Map Host 18000 to Container 3001 (NodeJS Server)
    volumes:
      - ./server:/app
      - /app/node_modules
      - ./server/uploads:/app/uploads
      - ./server/output:/app/output
    environment:
      - NODE_ENV=production
      - PORT=3001

    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    restart: always

  # # Secondary Server (CPU only) - Port 18000
  # server-cpu:
  #   build:
  #     context: ./server
  #     dockerfile: Dockerfile
  #   container_name: madcamp_server_cpu
  #   ports:
  #     - "18000:3001" # Map Host 18000 to Container 3001 (NodeJS Server - CPU Mode)
  #   volumes:
  #     - ./server:/app
  #     - /app/node_modules
  #     - ./server/uploads:/app/uploads
  #     - ./server/output:/app/output
  #   environment:
  #     - NODE_ENV=production
  #     - PORT=3001
  #   # No GPU deploy section needed for CPU version
  #   restart: always
