# ==============================================
# Web DAW Server - Hybrid Node.js + Python (GPU Enabled)
# ==============================================
FROM node:20-slim

WORKDIR /app

# ==============================================
# 1. System Dependencies
# ==============================================
# pkg-config, build-essential ë“± í•„ìˆ˜ ë„êµ¬ ì„¤ì¹˜
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3 \
    python3-pip \
    python3-venv \
    python3-dev \
    ffmpeg \
    libsndfile1 \
    libsndfile1-dev \
    rubberband-cli \
    librubberband-dev \
    git \
    curl \
    build-essential \
    pkg-config \
    alsa-utils \
    portaudio19-dev \
    && rm -rf /var/lib/apt/lists/*

# Symlink python3 -> python
RUN ln -sf /usr/bin/python3 /usr/bin/python

# ==============================================
# 2. Python Setup
# ==============================================
# ê°€ìƒí™˜ê²½ ìƒì„± ë° í™œì„±í™”
RUN python3 -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# pip ì—…ê·¸ë ˆì´ë“œ (setuptools<81: madmom pkg_resources ê²½ê³  ë°©ì§€)
RUN pip install --no-cache-dir --upgrade pip "setuptools<81" wheel

# [Build Dependencies]
# Madmom, Librosa ë¹Œë“œë¥¼ ìœ„í•´ Numpy(<2.0.0)ì™€ Cythonì„ ë¨¼ì € ì„¤ì¹˜
RUN pip install --no-cache-dir "numpy<2.0.0" "Cython>=0.29.30"

# requirements.txt ë³µì‚¬
COPY requirements.txt ./

# ğŸ”¥ [PyTorch GPU Version] - í•µì‹¬ ë³€ê²½ ì‚¬í•­
# Linux/CUDA 12.1 í™˜ê²½ì— ë§ëŠ” ë²„ì „ì„ ê°•ì œ ì„¤ì¹˜í•©ë‹ˆë‹¤.
# (ì„œë²„ ë“œë¼ì´ë²„ ë²„ì „ì— ë”°ë¼ cu118ë¡œ ë³€ê²½ ê°€ëŠ¥)
RUN pip install --no-cache-dir \
    torch==2.1.2+cu121 \
    torchaudio==2.1.2+cu121 \
    --index-url https://download.pytorch.org/whl/cu121

# [Install Remaining Dependencies]
# --no-build-isolation: ìœ„ì—ì„œ ì„¤ì¹˜í•œ numpy/Cythonì„ í™œìš©í•´ ë¹Œë“œ
RUN pip install --no-cache-dir --no-build-isolation -r requirements.txt

# [Install Extra Dependencies]
COPY requirements_extra.txt ./
RUN pip install --no-cache-dir -r requirements_extra.txt

# ==============================================
# 3. Node.js Setup
# ==============================================
COPY package*.json ./
RUN npm install

# ==============================================
# 4. Finalize
# ==============================================
COPY . .

# ê¶Œí•œ ì„¤ì • (mixed_results í´ë” í¬í•¨)
RUN mkdir -p uploads output mixed_results && chmod 777 uploads output mixed_results

EXPOSE 3001
ENV NODE_ENV=production
ENV PORT=3001

CMD ["node", "index.js"]