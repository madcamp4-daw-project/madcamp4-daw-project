# ==============================================
# Web DAW Server - Hybrid Node.js + Python
# ==============================================
# Node.js 20 (Debian Bookworm ê¸°ë°˜) - Python 3.11ì´ ê¸°ë³¸ ë‚´ì¥ë¨
FROM node:20-slim

# Set working directory
WORKDIR /app

# ==============================================
# 1. System Dependencies (Updated)
# ==============================================
# pkg-config ì¶”ê°€: Python ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¹Œë“œ ì‹œ í•„ìš”í•  ìˆ˜ ìˆìŒ
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3 \
    python3-pip \
    python3-venv \
    python3-dev \
    ffmpeg \
    libsndfile1 \
    libsndfile1-dev \
    rubberband-cli \
    librubberband-dev \
    git \
    curl \
    build-essential \
    pkg-config \
    && rm -rf /var/lib/apt/lists/*

# Create symlink for python
RUN ln -sf /usr/bin/python3 /usr/bin/python

# ==============================================
# 2. Python Virtual Environment & Dependencies
# ==============================================
# Create virtual environment
RUN python3 -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# Upgrade pip and install build dependencies
RUN pip install --no-cache-dir --upgrade pip setuptools wheel Cython

# Copy Python requirements first (for Docker layer caching)
COPY requirements.txt ./

# [Step A] PyTorch (CPU Version) - Explicit Install
# requirements.txtì— torchê°€ ìˆì–´ë„, ì—¬ê¸°ì„œ CPU ë²„ì „ì„ ë¨¼ì € ê°•ì œ ì„¤ì¹˜í•˜ì—¬
# ë¶ˆí•„ìš”í•œ GPU ë²„ì „(ìˆ˜ GB) ë‹¤ìš´ë¡œë“œë¥¼ ë°©ì§€í•©ë‹ˆë‹¤.
RUN pip install --no-cache-dir \
    torch==2.1.0+cpu \
    torchaudio==2.1.0+cpu \
    --index-url https://download.pytorch.org/whl/cpu

# [Step B] Install Requirements
# ğŸ”¥ ì¤‘ìš”: requirements.txtì— ì´ë¯¸ "numpy<2.0.0"ì´ ëª…ì‹œë˜ì–´ ìˆìœ¼ë¯€ë¡œ
# ë³„ë„ì˜ numpy ì„¤ì¹˜ ë¼ì¸ì„ ì œê±°í•˜ê³  requirements.txtë¥¼ ë”°ë¦…ë‹ˆë‹¤.
RUN pip install --no-cache-dir -r requirements.txt

# ==============================================
# 3. Node.js Dependencies
# ==============================================
# Copy package files first
COPY package*.json ./

# Install Node.js dependencies
RUN npm install

# ==============================================
# 4. Application Code
# ==============================================
COPY . .

# Create necessary directories (ê¶Œí•œ ë¬¸ì œ ë°©ì§€)
RUN mkdir -p uploads output && chmod 777 uploads output

# ==============================================
# 5. Environment & Runtime
# ==============================================
EXPOSE 3001

ENV NODE_ENV=production
# í¬íŠ¸ í™˜ê²½ë³€ìˆ˜ (í•„ìš”ì‹œ ìˆ˜ì •)
ENV PORT=3001

# ğŸ”¥ ì£¼ì˜: ì‹¤ì œ ì‹¤í–‰ íŒŒì¼ëª…ì´ index.jsì¸ì§€ server.jsì¸ì§€ í™•ì¸í•˜ì„¸ìš”!
CMD ["node", "index.js"]